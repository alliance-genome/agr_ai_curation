# Docker Compose configuration for running tests
# Usage: docker compose -f docker-compose.test.yml run --rm backend-tests
#
# To build the image with caching:
# docker compose -f docker-compose.test.yml build backend-tests

services:
  backend-tests:
    image: ai-curation-backend-tests:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    volumes:
      - ./backend:/app/backend
    environment:
      - PYTHONUNBUFFERED=1
      - WEAVIATE_HOST=weaviate-test
      - WEAVIATE_PORT=8080
      - WEAVIATE_SCHEME=http
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_TOKEN_PREFLIGHT_ENABLED=true
      - EMBEDDING_MODEL_TOKEN_LIMIT=8191
      - EMBEDDING_TOKEN_SAFETY_MARGIN=500
      - CONTENT_PREVIEW_CHARS=1600
      - WEAVIATE_BATCH_REQUESTS_PER_MINUTE=5000
    depends_on:
      weaviate-test:
        condition: service_healthy
    command: python -m pytest tests/ -v --tb=short
    networks:
      - test-network

  # Test-specific Weaviate instance
  weaviate-test:
    image: semitechnologies/weaviate:latest
    environment:
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: none
      ENABLE_MODULES: ''
      CLUSTER_HOSTNAME: weaviate-test
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8080/v1/.well-known/ready"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - test-network

  # Unit tests - lightweight image without ML dependencies (fast build)
  backend-unit-tests:
    image: ai-curation-unit-tests:latest
    build:
      context: .
      dockerfile: backend/Dockerfile.unit-test
    volumes:
      - ./backend:/app/backend
      - ./alliance_agents:/app/alliance_agents
      - ./config:/app/config
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY=test-key-for-unit-tests
      - LANGFUSE_PUBLIC_KEY=test-key
      - LANGFUSE_SECRET_KEY=test-key
      - DOCLING_TIMEOUT=300
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_TOKEN_PREFLIGHT_ENABLED=true
      - EMBEDDING_MODEL_TOKEN_LIMIT=8191
      - EMBEDDING_TOKEN_SAFETY_MARGIN=500
      - CONTENT_PREVIEW_CHARS=1600
      - WEAVIATE_BATCH_REQUESTS_PER_MINUTE=5000
    # Note: These ignores match .github/workflows/test.yml for CI consistency
    command: >
      python -m pytest tests/unit/ -v --tb=short --no-cov
      --ignore=tests/integration
      --ignore=tests/contract
      --ignore=tests/database
      --ignore=tests/unit/test_create_agent_cli.py
      --ignore=tests/unit/test_create_agent_validation.py
      --ignore=tests/unit/test_create_tool_cli.py
      --ignore=tests/unit/test_validate_registry.py
      --ignore=tests/unit/test_main_startup.py
      --ignore=tests/unit/api/test_files.py
      --ignore=tests/unit/lib/batch/test_batch_service.py
      --ignore=tests/unit/lib/agent_studio/test_registry_types.py
    networks:
      - test-network

  backend-integration-tests:
    image: ai-curation-backend-tests:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    volumes:
      - ./backend:/app/backend
    environment:
      - PYTHONUNBUFFERED=1
      - WEAVIATE_HOST=weaviate-test
      - WEAVIATE_PORT=8080
      - WEAVIATE_SCHEME=http
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_TOKEN_PREFLIGHT_ENABLED=true
      - EMBEDDING_MODEL_TOKEN_LIMIT=8191
      - EMBEDDING_TOKEN_SAFETY_MARGIN=500
      - CONTENT_PREVIEW_CHARS=1600
      - WEAVIATE_BATCH_REQUESTS_PER_MINUTE=5000
    depends_on:
      weaviate-test:
        condition: service_healthy
    command: python -m pytest tests/integration/ -v --tb=short
    networks:
      - test-network

  # Persistence tests - chunk storage verification against real Weaviate
  # Uses lightweight unit-test image: no ML deps needed (no torch/CUDA/unstructured)
  backend-persistence-tests:
    image: ai-curation-unit-tests:latest
    build:
      context: .
      dockerfile: backend/Dockerfile.unit-test
    volumes:
      - ./backend:/app/backend
    environment:
      - PYTHONUNBUFFERED=1
      - WEAVIATE_HOST=weaviate-test
      - WEAVIATE_PORT=8080
      - WEAVIATE_SCHEME=http
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_TOKEN_PREFLIGHT_ENABLED=false
      - EMBEDDING_MODEL_TOKEN_LIMIT=8191
      - EMBEDDING_TOKEN_SAFETY_MARGIN=500
      - CONTENT_PREVIEW_CHARS=1600
      - WEAVIATE_BATCH_REQUESTS_PER_MINUTE=5000
    depends_on:
      weaviate-test:
        condition: service_healthy
    command: python -m pytest tests/integration/persistence/ -v --tb=short --confcutdir=tests/integration/persistence
    networks:
      - test-network

  backend-contract-tests:
    image: ai-curation-backend-tests:latest
    build:
      context: ./backend
      dockerfile: Dockerfile.test
    volumes:
      - ./backend:/app/backend
    environment:
      - PYTHONUNBUFFERED=1
      - WEAVIATE_HOST=weaviate-test
      - WEAVIATE_PORT=8080
      - WEAVIATE_SCHEME=http
      - OPENAI_API_KEY=test-key
      - UNSTRUCTURED_API_URL=http://test-unstructured
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_TOKEN_PREFLIGHT_ENABLED=true
      - EMBEDDING_MODEL_TOKEN_LIMIT=8191
      - EMBEDDING_TOKEN_SAFETY_MARGIN=500
      - CONTENT_PREVIEW_CHARS=1600
      - WEAVIATE_BATCH_REQUESTS_PER_MINUTE=5000
    depends_on:
      weaviate-test:
        condition: service_healthy
    command: python -m pytest tests/contract/ -v --tb=short
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
